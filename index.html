<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa SatÃ©lite (MODIS/VIIRS) + Calles</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,body,#map {height:100%;margin:0;padding:0}
    .custom-button {
      position:absolute;
      top:10px;
      right:10px; /* ðŸ”¹ ahora en la esquina superior derecha */
      z-index:1000;
      background:white;
      padding:6px 12px;
      border:1px solid #ccc;
      border-radius:4px;
      cursor:pointer;
      font-family:sans-serif;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <button class="custom-button" id="toggleBtn">Ver Calles</button>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
  (async function(){

    function formatLocalDate(d){
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    async function tileExists(url){
      try {
        const res = await fetch(url, { method:'HEAD', mode:'cors' });
        return res.ok;
      } catch(e){
        return false;
      }
    }

    async function getValidDate(layerName, ext='jpg', z=2, lon=0, lat=0){
      const xtile = Math.floor((lon + 180) / 360 * Math.pow(2, z));
      const latRad = lat * Math.PI / 180;
      const ytile = Math.floor((1 - Math.log(Math.tan(latRad) + 1/Math.cos(latRad)) / Math.PI) / 2 * Math.pow(2, z));

      const today = new Date();
      const dToday = formatLocalDate(today);
      const urlToday = `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/${layerName}/default/${dToday}/GoogleMapsCompatible_Level9/${z}/${ytile}/${xtile}.${ext}`;
      if (await tileExists(urlToday)) return dToday;

      const yesterday = new Date(); yesterday.setDate(yesterday.getDate()-1);
      const dY = formatLocalDate(yesterday);
      const urlY = `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/${layerName}/default/${dY}/GoogleMapsCompatible_Level9/${z}/${ytile}/${xtile}.${ext}`;
      if (await tileExists(urlY)) return dY;

      return dToday;
    }

    const mapCenter = [-9.2, -75.0]; // PerÃº
    const initialZoom = 4;

    const modisLayerName = "MODIS_Aqua_CorrectedReflectance_TrueColor";
    const viirsLayerName = "VIIRS_SNPP_DayNightBand_At_Sensor_Radiance";

    const modisDate = await getValidDate(modisLayerName, "jpg", 2, mapCenter[1], mapCenter[0]);
    const viirsDate = await getValidDate(viirsLayerName, "png", 2, mapCenter[1], mapCenter[0]);

    const modis = L.tileLayer(
      `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/${modisLayerName}/default/${modisDate}/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpg`,
      { maxZoom: 9, attribution: "NASA MODIS Aqua TrueColor" }
    );

    const viirs = L.tileLayer(
      `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/${viirsLayerName}/default/${viirsDate}/GoogleMapsCompatible_Level8/{z}/{y}/{x}.png`,
      { maxZoom: 8, attribution: "NASA VIIRS NOAA-20 Day/Night Band Radiance" }
    );

    const streets = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      { maxZoom: 19, attribution: "Â© OpenStreetMap contributors" }
    );

    const hour = new Date().getHours();
    let satelliteLayer = (hour >= 6 && hour < 18) ? modis : viirs;

    const map = L.map("map", {
      center: mapCenter,
      zoom: initialZoom,
      layers: [satelliteLayer]
    });

    let showingStreets = false;
    const btn = document.getElementById("toggleBtn");

    btn.addEventListener("click", function(){
      if (showingStreets){
        map.removeLayer(streets);
        map.addLayer(satelliteLayer);
        btn.textContent = "Ver Calles";
        showingStreets = false;
      } else {
        map.removeLayer(satelliteLayer);
        map.addLayer(streets);
        btn.textContent = "Ver SatÃ©lite";
        showingStreets = true;
      }
    });

  })();
  </script>
</body>
</html>


