<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa Sat√©lite Calles + Comparaci√≥n + Indicadores</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body, #map { height:100%; margin:0; padding:0; }
    .controls {
      position:absolute; top:10px; right:10px;
      z-index:1000; display:flex; flex-direction:column; gap:8px;
    }
    .custom-button, .date-input {
      background:white; border:1px solid #ccc; border-radius:6px;
      font-family:sans-serif; padding:6px 10px; cursor:pointer;
      font-size:14px; box-shadow:0 1px 4px rgba(0,0,0,0.3);
    }
    .date-input { width:150px; }

    .compare-panel {
      position:absolute; top:60px; right:10px;
      background:white; border:1px solid #ccc; border-radius:8px;
      padding:10px; width:230px; font-family:sans-serif;
      box-shadow:0 2px 6px rgba(0,0,0,0.3); display:none; z-index:1100;
    }
    .compare-panel h4 {
      margin:0 0 8px; text-align:center; font-size:15px;
    }
    .compare-close {
      position:absolute; top:5px; right:8px; background:#eee; border:none;
      border-radius:50%; width:22px; height:22px; cursor:pointer; font-weight:bold;
    }

    .indicators-panel {
      position:absolute; top:60px; left:10px;
      background:white; border:1px solid #ccc; border-radius:8px;
      padding:10px; width:320px; max-height:80%; overflow-y:auto;
      font-family:sans-serif; box-shadow:0 2px 6px rgba(0,0,0,0.3);
      display:none; z-index:1100;
    }
    .indicators-panel h4 { margin-top:0; text-align:center; }
    .indicator-item { margin-bottom:10px; }
    .legend { font-size:12px; color:#555; margin-left:20px; }

    .date-label {
      position:absolute; bottom:15px; right:15px;
      background:rgba(0,0,0,0.6); color:white;
      padding:6px 12px; border-radius:6px; font-family:sans-serif;
      font-size:14px; display:none; z-index:1200;
    }
    .fade-layer { opacity:0; transition:opacity 1.5s ease; }
    .fade-layer.visible { opacity:1; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="controls">
    <input type="date" id="datePicker" class="date-input" />
    <button class="custom-button" id="toggleBtn">Ver Calles</button>
    <button class="custom-button" id="compareBtn">Comparar Fechas</button>
    <button class="custom-button" id="indicatorsBtn">Gases (TEMPO)</button>
  </div>

  <div class="compare-panel" id="comparePanel">
    <button class="compare-close" id="closeCompare">√ó</button>
    <h4>Comparaci√≥n</h4>
    <label>Fecha inicial:</label>
    <input type="date" id="startDate" style="width:100%; margin-bottom:8px;">
    <label>Fecha final:</label>
    <input type="date" id="endDate" style="width:100%; margin-bottom:8px;">
    <button id="startCompare" class="custom-button">Iniciar animaci√≥n</button>
    <button id="stopCompare" class="custom-button">Detener</button>
  </div>

  <div class="indicators-panel" id="indicatorsPanel">
    <h4>Indicadores de aire (TEMPO)</h4>

    <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
      <div style="flex:1">
        <label style="display:block; font-size:13px;">üìÖ Fecha (TEMPO)</label>
        <input type="date" id="tempoDate" style="width:100%; margin-bottom:4px;">
      </div>
      <div style="width:140px;">
        <label style="display:block; font-size:13px;">‚è± Hora (UTC)</label>
        <!-- step=1 to allow seconds -->
        <input type="time" id="tempoTime" step="1" style="width:100%; margin-bottom:4px;">
      </div>
    </div>
    <div style="display:flex; gap:8px; margin-bottom:10px;">
      <button id="setNowUtc" class="custom-button" style="flex:1">Ahora (UTC)</button>
      <button id="setMidnight" class="custom-button" style="flex:1">00:00:00Z</button>
    </div>

    <div id="indicatorsList"></div>
    <div style="font-size:12px; color:#444; margin-top:8px;">
      Nota: GIBS requiere timestamp ISO8601 completo, p.ej. <code>2025-10-02T23:11:48Z</code>.
      Si no hay tiles para ese instante exacto puede aparecer un fondo vac√≠o.
    </div>
  </div>

  <div class="date-label" id="dateLabel"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  (async function(){
    /* ---------- utilidades de fecha/hora ---------- */
    function formatLocalDate(d){
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    function getUtcTimeString(){
      const now = new Date();
      const hh = String(now.getUTCHours()).padStart(2,'0');
      const mm = String(now.getUTCMinutes()).padStart(2,'0');
      const ss = String(now.getUTCSeconds()).padStart(2,'0');
      return `${hh}:${mm}:${ss}`;
    }
    function buildIsoTimestamp(dateStr, timeStr){
      // dateStr: 'YYYY-MM-DD', timeStr: 'HH:MM' or 'HH:MM:SS'
      const d = dateStr || formatLocalDate(new Date());
      let t = timeStr || '00:00:00';
      const parts = t.split(':');
      const hh = String(parts[0] || '00').padStart(2,'0');
      const mm = String(parts[1] || '00').padStart(2,'0');
      const ss = String(parts[2] || '00').padStart(2,'0');
      return `${d}T${hh}:${mm}:${ss}Z`;
    }
    function dateRange(start,end){
      const result=[]; let c=new Date(start);
      while(c<=end){result.push(formatLocalDate(c)); c.setDate(c.getDate()+1);}
      return result;
    }

    /* ---------- mapa y capas base ---------- */
    const mapCenter=[-9.2,-75];
    const map=L.map("map",{center:mapCenter,zoom:4});
    const todayStr=formatLocalDate(new Date());
    const hour=new Date().getHours();

    function createLayers(dateStr){
      const modis=L.tileLayer(`https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_CorrectedReflectance_TrueColor/default/${dateStr}/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpeg`,
        {maxZoom:9,attribution:"NASA MODIS Terra"});
      const viirs=L.tileLayer(`https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/VIIRS_SNPP_DayNightBand_At_Sensor_Radiance/default/${dateStr}/GoogleMapsCompatible_Level8/{z}/{y}/{x}.png`,
        {maxZoom:8,attribution:"NASA VIIRS Night Band"});
      return {modis,viirs};
    }

    let {modis,viirs}=createLayers(todayStr);
    const streets=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19});
    let satelliteLayer=(hour>=6&&hour<18)?modis:viirs;
    satelliteLayer.addTo(map);

    /* ---------- elementos DOM ---------- */
    const btn=document.getElementById("toggleBtn");
    const datePicker=document.getElementById("datePicker");
    const compareBtn=document.getElementById("compareBtn");
    const indicatorsBtn=document.getElementById("indicatorsBtn");
    const comparePanel=document.getElementById("comparePanel");
    const closeCompare=document.getElementById("closeCompare");
    const indicatorsPanel=document.getElementById("indicatorsPanel");
    const tempoDate=document.getElementById("tempoDate");
    const tempoTime=document.getElementById("tempoTime");
    const setNowUtc=document.getElementById("setNowUtc");
    const setMidnight=document.getElementById("setMidnight");
    const dateLabel=document.getElementById("dateLabel");
    datePicker.value=todayStr; datePicker.max=todayStr;
    tempoDate.value=todayStr; tempoDate.max=todayStr;
    tempoTime.value=getUtcTimeString();
    let showingStreets=false;

    async function fadeToNewLayer(dateStr){
      const newLayers=createLayers(dateStr);
      const nextLayer=(hour>=6&&hour<18)?newLayers.modis:newLayers.viirs;
      nextLayer.addTo(map);
      const container=nextLayer.getContainer?.();
      if(container){
        container.classList.add("fade-layer");
        setTimeout(()=>container.classList.add("visible"),50);
        setTimeout(()=>{ map.removeLayer(satelliteLayer); satelliteLayer=nextLayer; updateIndicatorLayers(buildIsoTimestamp(tempoDate.value, tempoTime.value)); },1500);
      } else {
        map.removeLayer(satelliteLayer);
        satelliteLayer=nextLayer;
        updateIndicatorLayers(buildIsoTimestamp(tempoDate.value, tempoTime.value));
      }
    }

    datePicker.addEventListener("change",function(){
      if(this.value) fadeToNewLayer(this.value);
    });

    btn.addEventListener("click",()=>{
      if(showingStreets){
        map.removeLayer(streets); map.addLayer(satelliteLayer);
        btn.textContent="Ver Calles"; showingStreets=false;
      }else{
        map.removeLayer(satelliteLayer); map.addLayer(streets);
        btn.textContent="Ver Sat√©lite"; showingStreets=true;
      }
    });

    compareBtn.addEventListener("click",()=>{ comparePanel.style.display=comparePanel.style.display==="none"?"block":"none"; });
    closeCompare.addEventListener("click",()=>{ comparePanel.style.display="none"; });

    const startDate=document.getElementById("startDate");
    const endDate=document.getElementById("endDate");
    const startCompare=document.getElementById("startCompare");
    const stopCompare=document.getElementById("stopCompare");
    let animationTimer=null;
    stopCompare.disabled=true;

    startCompare.addEventListener("click",()=>{
      if(!startDate.value||!endDate.value){alert("Seleccione ambas fechas.");return;}
      const start=new Date(startDate.value), end=new Date(endDate.value);
      if(end<start){alert("La fecha final debe ser posterior.");return;}
      const diffDays=(end-start)/(1000*60*60*24);
      if(diffDays>30){alert("M√°ximo 30 d√≠as.");return;}
      const dates=dateRange(start,end); let index=0;
      stopCompare.disabled=false; startCompare.disabled=true;
      dateLabel.style.display="block";

      async function animate(){
        const d=dates[index]; await fadeToNewLayer(d);
        dateLabel.textContent=`üìÖ ${d}`;
        index=(index+1)%dates.length;
      }
      animate(); animationTimer=setInterval(animate,2200);
    });

    stopCompare.addEventListener("click",()=>{
      if(animationTimer) clearInterval(animationTimer);
      animationTimer=null; startCompare.disabled=false; stopCompare.disabled=true;
      dateLabel.style.display="none";
    });

    /* ---------- Indicadores TEMPO (con timestamp ISO) ---------- */
    const validIndicators = [
      { id: "TEMPO_L3_Formaldehyde_Vertical_Column", name: "Formaldehyde (L3, Vertical Column, Subdaily, TEMPO)" },
      { id: "TEMPO_L3_NO2_Vertical_Column_Troposphere", name: "Nitrogen Dioxide (L3, Vertical Column Troposphere, Subdaily, TEMPO)" },
      { id: "TEMPO_L3_Ozone_Profile_Troposphere_Column", name: "Ozone Profile (L3, Troposphere Column, Subdaily, TEMPO)" },
    ];

    const list = document.getElementById("indicatorsList");
    const indicatorLayers = {}; // { id: L.tileLayer(...) }

    // crear UI de checkboxes
    validIndicators.forEach(ind => {
      const div = document.createElement("div");
      div.className = "indicator-item";
      div.innerHTML = `<label><input type="checkbox" id="${ind.id}"> ${ind.name}</label>
                       <div class="legend">üõ∞Ô∏è ${ind.id}</div>`;
      list.appendChild(div);

      const checkbox = div.querySelector("input");
      checkbox.addEventListener("change", e => {
        const iso = buildIsoTimestamp(tempoDate.value || todayStr, tempoTime.value || getUtcTimeString());
        const id = ind.id;

        if (e.target.checked) {
          // al activar, ocultar la capa sat√©lite principal (opcional)
          if (map.hasLayer(satelliteLayer)) map.removeLayer(satelliteLayer);

          // crear la tile con timestamp ISO completo
          indicatorLayers[id] = L.tileLayer(
            `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/${id}/default/${iso}/GoogleMapsCompatible_Level7/{z}/{y}/{x}.png`,
            { maxZoom: 9, opacity: 1, attribution: "NASA GIBS" }
          ).addTo(map);
        } else if (indicatorLayers[id]) {
          map.removeLayer(indicatorLayers[id]);
          delete indicatorLayers[id];

          // si ya no hay capas indicador, restaurar sat√©lite
          if (Object.keys(indicatorLayers).length === 0 && !map.hasLayer(satelliteLayer)) {
            map.addLayer(satelliteLayer);
          }
        }
      });
    });

    // actualizar capas de indicadores usando un ISO timestamp (YYYY-MM-DDTHH:MM:SSZ)
    function updateIndicatorLayers(isoTimestamp){
      // isoTimestamp: string completo como '2025-10-02T23:11:48Z'
      for (const id in indicatorLayers){
        const wasVisible = map.hasLayer(indicatorLayers[id]);
        // remover antigua
        try { map.removeLayer(indicatorLayers[id]); } catch(e){}
        // crear nueva con timestamp
        indicatorLayers[id] = L.tileLayer(
          `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/${id}/default/${isoTimestamp}/GoogleMapsCompatible_Level7/{z}/{y}/{x}.png`,
          { maxZoom: 9, opacity: 1, attribution: "NASA GIBS" }
        );
        if (wasVisible) indicatorLayers[id].addTo(map);
      }
    }

    // listeners para que al cambiar fecha/hora se actualicen las capas TEMPO
    tempoDate.addEventListener("change", () => {
      const iso = buildIsoTimestamp(tempoDate.value || todayStr, tempoTime.value || getUtcTimeString());
      updateIndicatorLayers(iso);
    });
    tempoTime.addEventListener("change", () => {
      const iso = buildIsoTimestamp(tempoDate.value || todayStr, tempoTime.value || getUtcTimeString());
      updateIndicatorLayers(iso);
    });

    // botones auxiliares
    setNowUtc.addEventListener("click", () => {
      tempoTime.value = getUtcTimeString();
      const iso = buildIsoTimestamp(tempoDate.value || todayStr, tempoTime.value);
      updateIndicatorLayers(iso);
    });
    setMidnight.addEventListener("click", () => {
      tempoTime.value = "00:00:00";
      const iso = buildIsoTimestamp(tempoDate.value || todayStr, tempoTime.value);
      updateIndicatorLayers(iso);
    });

    indicatorsBtn.addEventListener("click",()=>{ 
      indicatorsPanel.style.display = indicatorsPanel.style.display==="none"?"block":"none"; 
    });

  })();
  </script>
</body>
</html>
