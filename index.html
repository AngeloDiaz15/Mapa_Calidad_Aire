<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Satélite MODIS/VIIRS + OSM</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    #toggleBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 6px 12px;
      border: 1px solid #aaa;
      border-radius: 4px;
      cursor: pointer;
      font-family: sans-serif;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <button id="toggleBtn">Ver calles</button>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
  // ---------- utilidades ----------
  function formatDate(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  async function tileExists(url){
    try {
      const res = await fetch(url, { method:'HEAD', mode:'cors', cache:'no-cache' });
      return res.ok;
    } catch(e){ return false; }
  }

  async function chooseValidDate(layerId, ext='jpg', level='GoogleMapsCompatible_Level8'){
    const today = new Date();
    const dToday = formatDate(today);
    const testUrl = `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/${layerId}/default/${dToday}/${level}/2/1/1.${ext}`;
    if (await tileExists(testUrl)) return dToday;

    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate()-1);
    const dY = formatDate(yesterday);
    return dY;
  }

  (async function(){
    // ---------- configuración ----------
    const center = [-9.2, -75.0]; // Perú
    const initialZoom = 4;

    // Fechas válidas
    const modisDate = await chooseValidDate("MODIS_Aqua_CorrectedReflectance_TrueColor", "jpg", "GoogleMapsCompatible_Level9");
    const viirsDate = await chooseValidDate("VIIRS_NOAA20_DayNightBand", "png", "GoogleMapsCompatible_Level8");

    // URLs
    const modisUrl = `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Aqua_CorrectedReflectance_TrueColor/default/${modisDate}/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpg`;
    const viirsUrl = `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/VIIRS_NOAA20_DayNightBand/default/${viirsDate}/GoogleMapsCompatible_Level8/{z}/{y}/{x}.png`;
    const osmUrl   = "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";

    // Capas
    const modis = L.tileLayer(modisUrl, { maxZoom: 9, attribution: "NASA MODIS Aqua" });
    const viirs = L.tileLayer(viirsUrl, { maxZoom: 8, attribution: "NASA VIIRS NOAA-20 DNB" });
    const streets = L.tileLayer(osmUrl, { maxZoom: 19, attribution: "© OpenStreetMap" });

    // Hora actual → día o noche
    const now = new Date();
    const hour = now.getHours();
    const isDay = (hour >= 6 && hour < 18);

    // Capa satelital inicial
    let satelliteLayer = isDay ? modis : viirs;

    // Crear mapa
    const map = L.map("map", {
      center: center,
      zoom: initialZoom,
      layers: [satelliteLayer]
    });

    // Alternar con botón
    let showingStreets = false;
    const btn = document.getElementById("toggleBtn");
    btn.addEventListener("click", function(){
      if(showingStreets){
        map.removeLayer(streets);
        map.addLayer(satelliteLayer);
        btn.textContent = "Ver calles";
        showingStreets = false;
      } else {
        map.removeLayer(satelliteLayer);
        map.addLayer(streets);
        btn.textContent = "Ver satélite";
        showingStreets = true;
      }
    });

  })();
  </script>
</body>
</html>




