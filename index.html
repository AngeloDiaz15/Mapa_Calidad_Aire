<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa Sat√©lite con Calles e Indicadores</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body, #map { height:100%; margin:0; padding:0; }
    .controls {
      position:absolute; top:10px; right:10px;
      z-index:1000; display:flex; flex-direction:column; gap:8px;
    }
    .custom-button, .date-input {
      background:white; border:1px solid #ccc; border-radius:6px;
      font-family:sans-serif; padding:6px 10px; cursor:pointer;
      font-size:14px; box-shadow:0 1px 4px rgba(0,0,0,0.3);
    }
    .date-input { width:150px; }
    .indicators-panel {
      position:absolute; top:60px; left:10px;
      background:white; border:1px solid #ccc; border-radius:8px;
      padding:10px; width:280px; max-height:80%; overflow-y:auto;
      font-family:sans-serif; box-shadow:0 2px 6px rgba(0,0,0,0.3);
      display:none; z-index:1100;
    }
    .indicators-panel h4 { margin-top:0; text-align:center; }
    .indicator-item { margin-bottom:10px; }
    .legend { font-size:12px; color:#555; margin-left:20px; }
    .fade-layer { opacity:0; transition:opacity 1.5s ease; }
    .fade-layer.visible { opacity:1; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="controls">
    <input type="date" id="datePicker" class="date-input" />
    <button class="custom-button" id="toggleBtn">Ver Calles</button>
    <button class="custom-button" id="indicatorsBtn">Indicadores de aire</button>
  </div>

  <div class="indicators-panel" id="indicatorsPanel">
    <h4>Indicadores de aire</h4>
    <div id="indicatorsList"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  (async function(){
    function formatLocalDate(d){
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    const mapCenter=[-9.2,-75];
    const map=L.map("map",{center:mapCenter,zoom:4});
    const todayStr=formatLocalDate(new Date());
    const hour=new Date().getHours();

    function createLayers(dateStr){
      const modis=L.tileLayer(`https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_CorrectedReflectance_TrueColor/default/${dateStr}/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpg`,
        {maxZoom:9,attribution:"NASA MODIS Terra"});
      const viirs=L.tileLayer(`https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/VIIRS_SNPP_DayNightBand_At_Sensor_Radiance_500m/default/${dateStr}/GoogleMapsCompatible_Level8/{z}/{y}/{x}.png`,
        {maxZoom:8,attribution:"NASA VIIRS Night Band"});
      return {modis,viirs};
    }

    let {modis,viirs}=createLayers(todayStr);
    const streets=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19});
    let satelliteLayer=(hour>=6&&hour<18)?modis:viirs;
    satelliteLayer.addTo(map);

    const btn=document.getElementById("toggleBtn");
    const datePicker=document.getElementById("datePicker");
    const indicatorsBtn=document.getElementById("indicatorsBtn");
    const indicatorsPanel=document.getElementById("indicatorsPanel");
    datePicker.value=todayStr; datePicker.max=todayStr;
    let showingStreets=false;
    let currentIndicator=null;

    // Transici√≥n suave
    async function fadeToLayer(newLayer){
      newLayer.addTo(map);
      const container=newLayer.getContainer?.();
      if(container){
        container.classList.add("fade-layer");
        setTimeout(()=>container.classList.add("visible"),50);
        setTimeout(()=>{
          map.eachLayer(l=>{ if(l!==newLayer) map.removeLayer(l); });
        },1500);
      }else{
        map.eachLayer(l=>{ if(l!==newLayer) map.removeLayer(l); });
      }
    }

    // Cambio por fecha
    datePicker.addEventListener("change",function(){
      const d=this.value;
      const newLayers=createLayers(d);
      const next=(hour>=6&&hour<18)?newLayers.modis:newLayers.viirs;
      currentIndicator=null;
      fadeToLayer(next);
      satelliteLayer=next;
    });

    // Alternar calles/sat√©lite
    btn.addEventListener("click",()=>{
      if(showingStreets){
        fadeToLayer(satelliteLayer);
        btn.textContent="Ver Calles"; showingStreets=false;
      }else{
        fadeToLayer(streets);
        btn.textContent="Ver Sat√©lite"; showingStreets=true;
      }
    });

    // ---- Indicadores ----
    const validIndicators=[
      {id:"OMPS_AI_L3_1day", name:"Aerosoles UV (OMPS AI)"},
      {id:"OMI_NO2_Column_Amount_Tropospheric", name:"Di√≥xido de nitr√≥geno (NO‚ÇÇ)"},
      {id:"OMI_SO2_Column_Amount_Day", name:"Di√≥xido de azufre (SO‚ÇÇ)"},
      {id:"OMI_Ozone_Column_Amount", name:"Ozono total (O‚ÇÉ)"},
      {id:"FIRMS_VIIRS_SNPP_Night", name:"Focos de calor (VIIRS)"}
    ];

    const list=document.getElementById("indicatorsList");
    validIndicators.forEach(ind=>{
      const div=document.createElement("div");
      div.className="indicator-item";
      div.innerHTML=`<label><input type="radio" name="indicator" value="${ind.id}"> ${ind.name}</label>
                     <div class="legend">üõ∞Ô∏è ${ind.id}</div>`;
      list.appendChild(div);
    });

    list.addEventListener("change",e=>{
      if(e.target.name!=="indicator") return;
      const id=e.target.value;
      const date=datePicker.value||todayStr;
      if(currentIndicator) map.removeLayer(currentIndicator);
      if(id==="none"){
        fadeToLayer(satelliteLayer);
        currentIndicator=null;
        return;
      }
      const newLayer=L.tileLayer(
        `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/${id}/default/${date}/GoogleMapsCompatible_Level8/{z}/{y}/{x}.png`,
        {maxZoom:8,attribution:"NASA GIBS"}
      );
      currentIndicator=newLayer;
      fadeToLayer(newLayer);
    });

    // Mostrar / ocultar panel
    indicatorsBtn.addEventListener("click",()=>{
      indicatorsPanel.style.display=indicatorsPanel.style.display==="none"?"block":"none";
    });
  })();
  </script>
</body>
</html>

